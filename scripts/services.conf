#!/bin/bash
# Link Project Service Registry
# This file maintains the official list of active and deprecated services
# Used by scripts to ensure consistency across the platform

# Active microservices (current production services)
SERVICES=(
    "user-svc"
    "chat-svc"
    "ai-svc"
    "discovery-svc"
    "search-svc"
    "feature-svc"
)

# Infrastructure services
INFRASTRUCTURE_SERVICES=(
    "api-gateway"
    "postgres"
    "redis"
    "localstack"
)

# Deprecated services (removed from production, kept for reference)
DEPRECATED_SERVICES=(
    "stories-svc"  # Removed in favor of integrated chat features
)

# Service ports (development environment)
declare -A SERVICE_PORTS=(
    ["api-gateway"]="8080"
    ["user-svc"]="8081"
    ["chat-svc"]="8082"
    ["ai-svc"]="8083"
    ["discovery-svc"]="8084"
    ["search-svc"]="8085"
    ["feature-svc"]="8086"
    ["postgres"]="5432"
    ["redis"]="6379"
    ["localstack"]="4566"
)

# Service database names
declare -A SERVICE_DATABASES=(
    ["user-svc"]="user_service_db"
    ["chat-svc"]="chat_service_db"
    ["ai-svc"]="ai_service_db"
    ["discovery-svc"]="discovery_service_db"
    ["search-svc"]="search_service_db"
    ["feature-svc"]="feature_service_db"
)

# Service health check endpoints
declare -A SERVICE_HEALTH_ENDPOINTS=(
    ["api-gateway"]="/health"
    ["user-svc"]="/health"
    ["chat-svc"]="/health"
    ["ai-svc"]="/health"
    ["discovery-svc"]="/health"
    ["search-svc"]="/health"
    ["feature-svc"]="/health"
)

# Functions for service validation and utilities

# Validate if a service is active
validate_service() {
    local service=$1
    if [[ ! " ${SERVICES[@]} " =~ " ${service} " ]]; then
        echo "‚ùå Error: Unknown service '$service'"
        echo "Valid services: ${SERVICES[*]}"
        return 1
    fi
    return 0
}

# Check if service is deprecated
is_deprecated() {
    local service=$1
    [[ " ${DEPRECATED_SERVICES[@]} " =~ " ${service} " ]]
}

# Get service port
get_service_port() {
    local service=$1
    echo "${SERVICE_PORTS[$service]:-8080}"
}

# Get service database name
get_service_database() {
    local service=$1
    echo "${SERVICE_DATABASES[$service]:-${service}_db}"
}

# Get service health endpoint
get_health_endpoint() {
    local service=$1
    echo "${SERVICE_HEALTH_ENDPOINTS[$service]:-/health}"
}

# List all active services
list_services() {
    echo "Active services:"
    for service in "${SERVICES[@]}"; do
        echo "  - $service (port: $(get_service_port $service))"
    done
}

# List deprecated services
list_deprecated() {
    echo "Deprecated services:"
    for service in "${DEPRECATED_SERVICES[@]}"; do
        echo "  - $service"
    done
}

# Export arrays for use in other scripts
export SERVICES
export INFRASTRUCTURE_SERVICES
export DEPRECATED_SERVICES
export SERVICE_PORTS
export SERVICE_DATABASES
export SERVICE_HEALTH_ENDPOINTS