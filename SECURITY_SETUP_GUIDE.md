# 🔐 Security Setup Guide: mTLS + Database Isolation

Complete guide for implementing enterprise-grade security features in the Link application.

## 🎯 What You Get

### ✅ **Database Isolation**
- Isolated databases per service (`link_users`, `link_chat`, etc.)
- Unique 32-character passwords per service
- SSL-encrypted database connections
- Connection pooling with PgBouncer

### ✅ **Automatic mTLS**
- Zero-config mutual TLS between all services
- Certificate rotation handled automatically
- Service-to-service authentication
- Traffic encryption and integrity

## 🚀 Quick Start

### Step 1: Database Isolation (Works with existing Docker Compose)
```bash
# Set PostgreSQL admin password
export POSTGRES_PASSWORD=your_secure_password

# Setup database isolation
cd terraform
../scripts/setup-security-features.sh development

# Start services (uses existing docker-compose.yml!)
cd ..
docker-compose up
```

### Step 2: mTLS Service Mesh (Kubernetes)
```bash
# Install Linkerd
./k8s/linkerd/install-linkerd.sh

# Deploy services with mTLS
kubectl apply -f k8s/linkerd/services-with-mtls.yaml

# Configure advanced features (optional)
./k8s/linkerd/configure-advanced-features.sh

# Verify mTLS is working
linkerd viz stat deployment -n link-services
```

## 🏗️ Architecture Changes

### Before:
```
┌─────────────┐    HTTP     ┌─────────────┐
│ User Service│────────────▶│ Chat Service│
└─────────────┘             └─────────────┘
       │                           │
       ▼                           ▼
┌─────────────────────────────────────────┐
│          Shared Database                │
│         (linkdb - insecure)             │
└─────────────────────────────────────────┘
```

### After:
```
┌─────────────┐   mTLS/HTTPS  ┌─────────────┐
│ User Service│◀──────────────▶│ Chat Service│
│  (Linkerd)  │   (Encrypted)  │  (Linkerd)  │
└─────────────┘               └─────────────┘
       │                           │
       ▼ SSL                       ▼ SSL
┌─────────────┐               ┌─────────────┐
│ link_users  │               │ link_chat   │
│  Database   │               │  Database   │
│  (Isolated) │               │ (Isolated)  │
└─────────────┘               └─────────────┘
```

## 📁 Files Created

### Basic Setup:
- `k8s/linkerd/install-linkerd.sh` - Linkerd installation
- `k8s/linkerd/services-with-mtls.yaml` - Service deployments with mTLS
- `scripts/setup-security-features.sh` - Database isolation setup

### Advanced Features:
- `k8s/linkerd/configure-advanced-features.sh` - Advanced configuration
- `k8s/linkerd/linkerd-production-config.yaml` - Zero-trust policies
- `k8s/linkerd/linkerd-monitoring.yaml` - Monitoring and alerts

### Generated by Terraform:
- `.env/` directory with service-specific credentials
- Kubernetes secrets for production deployment
- Backup and migration scripts

## ⚙️ Additional Linkerd Configuration

### **Basic Installation** (Covered):
- ✅ Control plane installation
- ✅ Viz extension for observability
- ✅ Namespace injection
- ✅ Service mesh automatic mTLS

### **Advanced Features** (Optional but Recommended):

1. **Zero-Trust Policies**:
   ```bash
   # Server authorization - only allow specific services to communicate
   # Defined in linkerd-production-config.yaml
   ```

2. **Performance Optimization**:
   ```yaml
   # HTTP/2 for all services
   proxyProtocol: HTTP/2
   
   # Proxy resource tuning
   config.linkerd.io/proxy-cpu-request: "50m"
   config.linkerd.io/proxy-memory-request: "32Mi"
   ```

3. **Monitoring Integration**:
   ```bash
   # Prometheus metrics
   # Grafana dashboards
   # Custom alerts for mTLS failures
   ```

4. **Distributed Tracing**:
   ```bash
   # Jaeger integration
   # Request flow visualization
   # Performance profiling
   ```

5. **Traffic Management**:
   ```yaml
   # Traffic splitting for canary deployments
   # Circuit breakers
   # Retry policies
   ```

## 🔧 Configuration Levels

### **Level 1: Basic mTLS** (Good for most cases)
```bash
./k8s/linkerd/install-linkerd.sh
kubectl apply -f k8s/linkerd/services-with-mtls.yaml
```
**Gets you**: Automatic mTLS, observability, certificate rotation

### **Level 2: Production-Ready** (Recommended)
```bash
# After Level 1:
./k8s/linkerd/configure-advanced-features.sh
```
**Adds**: Zero-trust policies, monitoring, tracing, performance tuning

### **Level 3: Enterprise** (For high-security environments)
```bash
# Custom configurations for:
# - Multi-cluster mTLS
# - External certificate management
# - Custom authorization policies
# - Integration with existing PKI
```

## 🎯 Answer: Additional Configuration Needed?

### **For Basic mTLS**: ✅ **No additional config needed**
Your `install-linkerd.sh` script covers everything for automatic mTLS.

### **For Production**: 🔧 **Yes, recommend additional config**
1. **Zero-trust policies** (`linkerd-production-config.yaml`)
2. **Monitoring integration** (`linkerd-monitoring.yaml`) 
3. **Performance tuning** (already included in service deployments)
4. **Distributed tracing** (Jaeger extension)

### **For Your Use Case**: 
- **Start with basic**: Get mTLS working first
- **Add advanced later**: Zero-trust policies and monitoring
- **Everything is optional**: Basic mTLS provides excellent security

## 🚨 Important Notes

1. **No Code Changes Needed**: Your services work as-is
2. **Database Isolation**: Use existing `docker-compose.yml`
3. **mTLS**: Happens automatically when pods are injected
4. **Observability**: Built-in dashboards and metrics

**Bottom line**: The basic installation gives you production-grade mTLS. Advanced features are nice-to-have for enterprise environments!
