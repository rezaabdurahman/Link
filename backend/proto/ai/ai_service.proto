syntax = "proto3";

package ai;

option go_package = "github.com/link-app/backend/proto/ai";

import "google/protobuf/timestamp.proto";
import "proto/common/types.proto";

// AI Service definition
service AIService {
  // Summarize conversation messages
  rpc SummarizeConversation(SummarizeConversationRequest) returns (SummarizeConversationResponse);
  
  // Generate response suggestions
  rpc GenerateResponseSuggestions(GenerateResponseSuggestionsRequest) returns (GenerateResponseSuggestionsResponse);
  
  // Analyze message sentiment
  rpc AnalyzeSentiment(AnalyzeSentimentRequest) returns (AnalyzeSentimentResponse);
  
  // Stream conversation summarization (for large conversations)
  rpc StreamSummarization(StreamSummarizationRequest) returns (stream SummarizationChunk);
  
  // Check user consent for AI processing
  rpc CheckUserConsent(CheckUserConsentRequest) returns (CheckUserConsentResponse);
  
  // Update user consent preferences
  rpc UpdateUserConsent(UpdateUserConsentRequest) returns (UpdateUserConsentResponse);
  
  // Generate conversation insights
  rpc GenerateInsights(GenerateInsightsRequest) returns (GenerateInsightsResponse);
  
  // Generate conversational cue cards
  rpc GenerateCueCards(GenerateCueCardsRequest) returns (GenerateCueCardsResponse);
  
  // Generate message from selected cue card with tonality adjustment
  rpc GenerateMessageFromCue(GenerateMessageFromCueRequest) returns (GenerateMessageFromCueResponse);
  
  // Analyze user tonality patterns
  rpc AnalyzeTonality(AnalyzeTonalityRequest) returns (AnalyzeTonalityResponse);
  
  // Health check
  rpc Health(common.HealthCheckRequest) returns (common.HealthCheckResponse);
}

// AI processing consent levels
enum ConsentLevel {
  NONE = 0;
  BASIC = 1;
  FULL = 2;
}

// Sentiment analysis result
enum Sentiment {
  NEUTRAL = 0;
  POSITIVE = 1;
  NEGATIVE = 2;
  MIXED = 3;
}

// Message for AI processing
message AIMessage {
  common.UUID id = 1;
  common.UUID sender_id = 2;
  string content = 3;
  google.protobuf.Timestamp timestamp = 4;
  map<string, string> metadata = 5;
}

// User consent preferences
message UserConsent {
  common.UUID user_id = 1;
  ConsentLevel conversation_summarization = 2;
  ConsentLevel sentiment_analysis = 3;
  ConsentLevel response_suggestions = 4;
  ConsentLevel insights_generation = 5;
  bool data_retention_allowed = 6;
  google.protobuf.Timestamp updated_at = 7;
  google.protobuf.Timestamp expires_at = 8;
}

// Summarization request
message SummarizeConversationRequest {
  common.UUID conversation_id = 1;
  repeated AIMessage messages = 2;
  common.UUID requesting_user_id = 3;
  int32 max_summary_length = 4;
  string summary_style = 5; // "brief", "detailed", "bullet_points"
  repeated string focus_topics = 6;
}

message SummarizeConversationResponse {
  string summary = 1;
  repeated string key_topics = 2;
  repeated Participant participants = 3;
  int32 message_count = 4;
  google.protobuf.Timestamp conversation_period_start = 5;
  google.protobuf.Timestamp conversation_period_end = 6;
  float confidence_score = 7;
  common.SuccessResponse result = 8;
}

message Participant {
  common.UUID user_id = 1;
  string role = 2; // "active", "observer", "moderator"
  int32 message_count = 3;
  Sentiment dominant_sentiment = 4;
}

// Response suggestions
message GenerateResponseSuggestionsRequest {
  common.UUID conversation_id = 1;
  repeated AIMessage recent_messages = 2;
  common.UUID requesting_user_id = 3;
  int32 suggestion_count = 4;
  string tone = 5; // "casual", "formal", "friendly", "professional"
}

message GenerateResponseSuggestionsResponse {
  repeated ResponseSuggestion suggestions = 1;
  common.SuccessResponse result = 2;
}

message ResponseSuggestion {
  string text = 1;
  string category = 2; // "question", "agreement", "clarification", "emoji"
  float confidence_score = 3;
  string reasoning = 4;
}

// Sentiment analysis
message AnalyzeSentimentRequest {
  repeated AIMessage messages = 1;
  common.UUID requesting_user_id = 2;
  bool include_individual_analysis = 3;
}

message AnalyzeSentimentResponse {
  Sentiment overall_sentiment = 1;
  float confidence_score = 2;
  repeated MessageSentiment individual_sentiments = 3;
  SentimentTrends trends = 4;
  common.SuccessResponse result = 5;
}

message MessageSentiment {
  common.UUID message_id = 1;
  Sentiment sentiment = 2;
  float confidence_score = 3;
  repeated string emotion_tags = 4;
}

message SentimentTrends {
  repeated SentimentDataPoint trend_points = 1;
  string trend_direction = 2; // "improving", "declining", "stable"
}

message SentimentDataPoint {
  google.protobuf.Timestamp timestamp = 1;
  Sentiment sentiment = 2;
  float confidence_score = 3;
}

// Streaming summarization
message StreamSummarizationRequest {
  common.UUID conversation_id = 1;
  common.UUID requesting_user_id = 2;
  int32 chunk_size = 3;
  string summary_style = 4;
}

message SummarizationChunk {
  string partial_summary = 1;
  int32 messages_processed = 2;
  int32 total_messages = 3;
  bool is_final = 4;
  repeated string interim_topics = 5;
}

// User consent operations
message CheckUserConsentRequest {
  common.UUID user_id = 1;
  repeated string operation_types = 2; // Types of AI operations to check
}

message CheckUserConsentResponse {
  UserConsent consent = 1;
  map<string, bool> operation_permissions = 2;
  bool consent_required = 3;
}

message UpdateUserConsentRequest {
  common.UUID user_id = 1;
  ConsentLevel conversation_summarization = 2;
  ConsentLevel sentiment_analysis = 3;
  ConsentLevel response_suggestions = 4;
  ConsentLevel insights_generation = 5;
  bool data_retention_allowed = 6;
  google.protobuf.Timestamp expires_at = 7;
}

message UpdateUserConsentResponse {
  UserConsent consent = 1;
  common.SuccessResponse result = 2;
}

// Insights generation
message GenerateInsightsRequest {
  common.UUID user_id = 1;
  repeated common.UUID conversation_ids = 2;
  google.protobuf.Timestamp period_start = 3;
  google.protobuf.Timestamp period_end = 4;
  repeated string insight_types = 5; // "communication_patterns", "topic_preferences", "sentiment_trends"
}

message GenerateInsightsResponse {
  repeated Insight insights = 1;
  common.SuccessResponse result = 2;
}

message Insight {
  string type = 1;
  string title = 2;
  string description = 3;
  map<string, string> data = 4;
  float confidence_score = 5;
  repeated string supporting_evidence = 6;
  google.protobuf.Timestamp generated_at = 7;
}

// Cue card generation modes
enum CueCardGenerationMode {
  CONTEXTUAL = 0;      // Based on current conversation
  COLD_START = 1;      // New conversation with no history
  RE_ENGAGEMENT = 2;   // Reviving stale conversation
}

// Tonality analysis scope
enum TonalityScope {
  CONVERSATION_SPECIFIC = 0; // This conversation only
  USER_GENERAL = 1;          // Across all conversations
  MUTUAL_ADAPTATION = 2;     // Between two specific users
}

// User context for cue card generation
message UserContext {
  repeated string interests = 1;
  string communication_style = 2;
  map<string, float> topic_preferences = 3;
  TonalityProfile tonality_profile = 4;
}

// User tonality profile
message TonalityProfile {
  float formality_score = 1;     // 0.0 (casual) to 1.0 (formal)
  float enthusiasm_score = 2;    // 0.0 (reserved) to 1.0 (enthusiastic)
  float brevity_score = 3;       // 0.0 (verbose) to 1.0 (concise)
  repeated string common_phrases = 4;
  map<string, float> emoji_usage = 5; // emoji -> frequency
}

// Individual cue card
message CueCard {
  string id = 1;
  string prompt_text = 2;        // Short text shown on card
  string category = 3;           // question, activity, follow-up, interest, plans
  float relevance_score = 4;
  CueCardMetadata metadata = 5;
}

// Cue card metadata
message CueCardMetadata {
  string reasoning = 1;          // Why this suggestion was made
  repeated string context_signals = 2; // What influenced this suggestion
  string tone_adjustment = 3;    // How tone will be adjusted
}

// Tonality adjustments applied to messages
message TonalityAdjustments {
  string original_tone = 1;
  string adjusted_tone = 2;
  repeated string modifications = 3; // e.g., "added emoji", "made more casual"
}

// Tonality insight
message TonalityInsight {
  string type = 1;               // e.g., "greeting_style", "question_pattern"
  string observation = 2;
  float confidence = 3;
}

// === REQUEST/RESPONSE MESSAGES ===

// Cue card generation request
message GenerateCueCardsRequest {
  common.UUID conversation_id = 1;
  common.UUID requesting_user_id = 2;
  repeated AIMessage recent_messages = 3; // Last 10-20 messages
  UserContext user_context = 4;
  int32 card_count = 5;                   // Default 3
  CueCardGenerationMode mode = 6;
}

// Cue card generation response
message GenerateCueCardsResponse {
  repeated CueCard cue_cards = 1;
  TonalityProfile tonality_analysis = 2;
  common.SuccessResponse result = 3;
}

// Message generation from cue card request
message GenerateMessageFromCueRequest {
  common.UUID conversation_id = 1;
  common.UUID requesting_user_id = 2;
  CueCard selected_card = 3;
  TonalityProfile user_tonality = 4;
  TonalityProfile conversation_tonality = 5;
  bool apply_tonality_adjustment = 6;
}

// Message generation from cue card response
message GenerateMessageFromCueResponse {
  string message = 1;
  TonalityAdjustments adjustments_applied = 2;
  float confidence_score = 3;
  common.SuccessResponse result = 4;
}

// Tonality analysis request
message AnalyzeTonalityRequest {
  common.UUID user_id = 1;
  repeated AIMessage messages = 2;
  TonalityScope scope = 3;
}

// Tonality analysis response
message AnalyzeTonalityResponse {
  TonalityProfile profile = 1;
  map<string, float> pattern_confidence = 2;
  repeated TonalityInsight insights = 3;
  common.SuccessResponse result = 4;
}